<?xml version="1.0" encoding="utf-8"?>
{% set ns = namespace(count=0, latest=None) %}
{% set url %}{% include 'links-prefix.txt' %}{{ url_for('view_user', username=user.username) }}{% endset %}
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>@{{ user.username }} Feed | {% include 'app-title.txt' %}</title>
  <id>{{ url }}</id>
  <link rel="alternate" type="text/html" href="{{ url }}" />
  <link rel="self" type="{{ content_type }}" href="{% include 'links-prefix.txt' %}{{ url_for('view_user_feed', username=user.username) }}" />
  <generator uri="{{ config.APP_REPO }}">{{ config.APP_NAME }}</generator>
  {%- for folder, collection in collections.items() -%}
    {%- for iid in collection['items'] -%}
      {%- if ns.count < limit -%}
        {%- with item=load_item(iid) -%}
          {% if item and (not item.status or item.status == "public") %}
            {% include 'feed-entry.xml' %}
            {% set ns.count = ns.count + 1 %}
            {% if not ns.latest %}
              {% set ns.latest = item %}
            {% endif %}
          {% endif %}
        {%- endwith -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endfor -%}
  {% if ns.latest and ns.latest.datetime %}
    <updated>{{ ns.latest.datetime.replace(' ', 'T') }}Z</updated>
  {% endif %}
</feed>